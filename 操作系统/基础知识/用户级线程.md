# 用户级线程  


## 线程的引入  

**进程 = 资源 + 指令执行序列**  

其中**资源表示映射表(内存资源)**，那么多进程切换时，能否只切换指令序列变换，而资源不变换？  
* 将资源和指令执行分来  
* 一个资源+多个指令执行序列  

### 线程  

在一个资源下，启动了多个轻巧的指令序列，这个指令序列可以来回切，而且切换的时候只切换指令序列不需要动资源，既然也是指令序列在来回切，而且和进程不同(不需要特别复杂)，就叫**线程**

* **保留了并发的优点，避免了进程切换代价**  
* 进程的切换可以分成两部分，指令切换+映射表切换(内存管理部分)  
* 线程的切换可以只关注指令的切换  

![image](https://user-images.githubusercontent.com/58176267/156487067-cb07e0f7-bbcd-4587-8a2d-9dcce081df1a.png)


#### 线程的价值 即 多个指令序列 + 一个地址空间是否实用  

* 一个网页浏览器  
    * 一个线程用来从服务器接收数据  
    * 一个线程用来显示图片  
    * 一个线程用来出来图片(如解压缩)  
    * 一个线程用来显示图片  

* 上面这些如果变成顺序执行，就需要先下载数据，等所有数据下载完，再调用另外一段程序来显示文本，执行完以后，再调用另外一段程序显示图片  
* 因此这些**线程需要共享资源**
    * 接收数据放在内存100处，需要显示时从该处读  
    * 所有的文本、图片都显示在一个屏幕上  
* 合理的顺序是：启动一段程序，接收数据，启动一段程序显示文本，另一段程序显示图片，这些程序序列交替执行  
* 这样的例子为什么不是**进程**是而叫**线程**：因为指令序列1需要从服务器拿到数据放在缓冲区, 另一个指令序列需要从缓冲区拿数据来显示，如果两个指令序列用的不是同一个映射，就需要从放数据的缓冲区拷贝数据到自己读数据的缓冲区太费劲，本身就需要共享缓冲区，共享资源，没必要分开  


### 怎么实现线程  

注意：只是同时让两个指令序列开始执行不叫并发，还需要两指令序列交替执行  

![image](https://user-images.githubusercontent.com/58176267/156489305-3418c7b4-7bbc-4503-b48d-301da8181ca9.png)


上面的例子中，create函数，就能让他们同时出发  
Yield函数，能让他们交替执行,程序A执行过程中通过Yield函数切出去  

* 核心是Yield
* 能切换就知道**切换时需要是什么样子**  
* Create就是要制造出**第一次切换时应该的样子**

### 两个执行序列(线程)与一个栈的问题  

两段执行序列，第一段执行序列执行100处A函数，然后调用B函数(需要将返回地址104压栈，执行完B就知道再从104地址开始执行)，执行B函数时通过Yiled()函数切换到另一个指令序列执行(本质也是一个函数，也要压栈)；  Yiled函数找到另一段指令执行序列的地址300并修改PC指针跳转到300处，执行C函数，C函数调用D函数(压入304)，D函数调用Yiled函数切回第一个指令序列(压入404)，Yiled()函数找到204地址，继续执行B函数  

但是接着执行B函数发现函数结束(遇到}，需要出栈)，结果弹出的地址是404，但是我们执行完B函数需要的是回到A函数中也就是104位置，所以这里发生了错乱，**原因就在于两个指令序列用了一个栈**  

![image](https://user-images.githubusercontent.com/58176267/156490334-c90353dc-56fd-43e6-8463-83d71ede5dd3.png)

### TCB  

TCB是一个全局的数据结构，存放栈指针  
**esp：物理寄存器，CPU中的寄存器，所以切换栈实际上就是修改这个寄存器的值**

如下面示例中，线程1的TCB1存放的是1000，表示线程1用的是1000这个地方的栈; 线程2用的是2000地方的栈，因此TCB2.esp = 2000  

在Yiled切换线程时，如从线程2切换到线程1，首先要将当前栈记录进TCB2.esp,即TCB2.esp = esp(因为现在执行的是线程2，它内部的函数调用等，返回地址都被压入了栈，而栈地址被保存在CPU寄存器esp中),然后找到TCB1.esp给当前esp，再跳转到线程1刚才切换到线程2的地方，也就是204处  

![image](https://user-images.githubusercontent.com/58176267/156496526-bc6d0875-c276-46a2-8d3f-18ce58d9c033.png)



